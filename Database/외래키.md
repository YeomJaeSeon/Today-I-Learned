# 외래키
- innodb storage engine에서만 외래키 생성 가능
- 외래키 제약이 설정되면 자동으로 연관된 테이블의 칼럼에 인덱스까지 생성된다.
  - 보통 연관된 테이블의 pk로 외래키를 사용하지 않나? 연관된 테이블의 칼럼에 인덱스 생성된다는게 뭘까?

## 외래키 관리 두가지 특정
1. 쓰기잠금이 발생하는 경우 잠금대기 발생O
2. 외래키와 연관되지 않는 칼럼의 변경은 잠금대기 발생X

### 1번 특징
```sql
-- session a
start transaction ;

update tb_parent set fd = 'chagned-2' where id = 2;

rollback ;
```

```sql
-- session b
start transaction ;

update tb_child set pid=2 where id = 100;

rollback ;
```

- session b는 session a에서 접근하는 연관된 레코드의 쓰기잠금을 release할때까지 대기한다.
- sessin b는 외래키를 수정하려 하였기 때문이다

### 2번 특징
```sql
-- session a
start transaction ;

update tb_parent set fd = 'chagned-2' where id = 2;

rollback ;
```

```sql
-- session b
start transaction ;

update tb_child set fd='changed-100' where id = 100;

rollback ;
```
- session b는 session a에서 접근하는 연관된 레코드의 쓰기잠금을 release할때까지 대기하지 않는다.
- sessin b는 외래키와 상관없는 칼럼을 수정하기 때문이다.

### delete on cascade
- 부모 테이블의 레코드를 삭제하면 해당 부모테이블과 연관된 자식 레코드들도 삭제되는 외래키 옵션 delete on cascade

```sql
-- session a
start transaction ;

update tb_child set fd='changed-100' where id = 101;

rollback ;
```

```sql
-- session b
start transaction ;

delete from tb_parent where id = 2;

rollback ;
```

- session a가 쓰기잠금 가지고있으면, sessionb는 대기한다.
- session b가 커밋되면 해당 부모테이블과 연관된 자식테이블이 모두 삭제되기 때문