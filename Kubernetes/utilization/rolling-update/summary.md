# 11.3.1 디플로이먼트를 통한 롤링 업데이트

- 쿠버네티스에서 어플을 배포하려면 어떤 방법을 사용해야 할까?
- 야믈 파일을 통해 `kubectl apply -f` 명령어로 디플로이먼트를 생성함으로써 여러 개의 포드를 배포하는 방식을 생각해 볼 수 있다.
- 좀더 고도화된 배포 방식을 원한다면 Spinnaker, Helm..이런 게 있다.

→ 쿠버에서는 어플리케이션을 안정적으로 배포할수 있도록,, 점진적으로 새로운 버전을 배포할 수 있도록 디플로이먼트에서 **롤링 업데이트** 기느을 사용할 수 있다.

!!참고!!

롤링 업데이트는 **파드 인스턴스를 점진적으로 새로운 것으로 업데이트하여 디플로이먼트 업데이트가 서비스 중단 없이 이루어질 수 있도록 해준다**

## 디플로이먼트를 이용한 레플리카셋의 버전 관리

- 디플로이먼트의 장점은 레플리카셋의 변경사항인 리비전을 디플로이먼트가 관리하는것!
    - 히스토리들을 알기에 롤백하기가 쉽다.

## 디플로이먼트를 통한 롤링 업데이트 설정

- ReCreate: 기존 버전의 모든 포드 삭제후 새로운 버전의 포드 생성
    - 모든 포드가 삭제되면 지속적으로 사용자의 요청을 처리해야하는 서비스에는 적절하지 못함. 만약 그렇지 않은 서비스라면 괜찮음!
    
    ```yaml
    apiVersion: apps/v1
    kind: Deployment
    metadata:
      name: deployment-recreate
    spec:
      replicas: 3
      strategy:
        type: Recreate # 여기에 적으면 된다. 
    ```
    
    - Recreate 는 기존의 모든 포드를 한번에 삭제하기에 적합하지 않은 서비스에는 사용할수없다. 그래서 몇개의 포드만 삭제하고 생성하는 롤링 업데이트 기능도 제공한다.
    
    ```yaml
    apiVersion: apps/v1
    kind: Deployment
    metadata:
      name: deployment-recreate
    spec:
      replicas: 3
        strategy:
    	  type: Recreate # 여기에 적으면 된다. 
    	  rollinUpdate:
    	    maxSurge: 2 # 롤링 업데이트 도중 전체 포드의 개수가 replicas값보다 얼마나 많이 존재할수있는지. 여기서는 롤링 업데이트 도중 총 5개의 포드가 존재할수있다.
    		maxUnavailable: 2 # 롤링 업데이트 도중 사용 불가능한 상태의 포드의 최대 개수.. 이거보다 더 많은 포드가 사용 불가능중일수 없다.
   
   # 적어도 1개의 포드는 실행중이다.
    ```
    
    - replicas에 정의한 포드의 개숭
    
    ## 블루 그린 배포 사용하기
    
    - 기존 버전의 포드를 그대로 놔둔 상태에서 새로운 버전의 포드를 미리 생성해 둔 뒤, 서비스의 라우팅만 변경하는 배포 방식을 의미한다.
    - 롤링업데이트와 달리 특정 순간에 두 버전의 어플이 공존하지 않으며, 중단 시간이 발생하지 않는다.
    
    1. v1버전의 디플로이먼트가 존재하고 서비스는 v1디플로이먼트에 라우팅. v1디플로이먼트의 포드들이 처리중.
    2. 새로운 버전 v2 디플로이먼트를 생성, v2포드도 생성
    3. 서비스는 라우팅이 v2디플로이먼트로 가도록 수정
    4. v2디플로이먼트가 잘동작하면  v1디플로이먼트 삭제
    
    ⇒ 쿠버에서 블루그린 배포라는 것을 제공하는 것이아니라 이렇게 디플로이먼트와 서비스를 이용하여 우리가 사용할수 있따.
    
    ⇒ 특정 시점에 포드가 두배는 존재하여 실행되기 때문에 전체적인(전체 노드를 의미함) 자원을 많이 소모할수있다.
